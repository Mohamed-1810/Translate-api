const ffmpeg = require("fluent-ffmpeg")
const fs = require("fs")
const googleTTS = require("google-tts-api");

function sleep(ms) {
    return new Promise((res) => {
        setTimeout(res, ms);
    });
}

let googleTTSapi = {};

googleTTSapi.get = (browser, settings) => {
    return new Promise(async (resolve, reject) => {
        const urls = googleTTS.getAllAudioUrls(settings.text, {
            lang: 'en',
            slow: false,
            host: 'https://translate.google.com',
        });
    
        if(urls && urls.length > 0){
            let outputString = ""
    
            let ffmpegProcess = ffmpeg()
            .audioBitrate("328k")
    
            for (let i = 0; i < urls.length; i++){

                ffmpegProcess.addInput(urls[i].url)
                outputString += `[${i}:a]`
            }
    
            ffmpegProcess.complexFilter(`${outputString}concat=n=${urls.length}:v=0:a=1`)
            ffmpegProcess.save(settings.output)
            .on("end", resolve)
            .on("error", reject)
        } else {
            reject(Error("URLS is empty"))
        }
    });
};

module.exports = googleTTSapi;